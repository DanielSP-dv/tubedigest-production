# Story 2.1: Channel Selection Onboarding

## Status
**Current Status:** Draft  
**Created:** 2025-01-27  
**Assigned To:** @dev.mdc  
**Priority:** High  

## Epic
Channel Selection

## Story Number
2.1

## Title
Channel Selection Onboarding

## Story
**As a** user,
**I want** to select and manage my YouTube channel subscriptions,
**so that** I can receive personalized video digests from my preferred content creators.

## Acceptance Criteria
1. User can view a list of their YouTube channel subscriptions
2. User can select up to 10 channels for digest processing
3. User can deselect previously chosen channels
4. User can set digest frequency preferences (daily, weekly, monthly)
5. User preferences are persisted in the database
6. Selected channels are displayed in the dashboard sidebar
7. Channel selection persists across browser sessions
8. User receives confirmation when channels are successfully saved

## Tasks / Subtasks
- [ ] Task 1: Implement YouTube API integration for channel fetching (AC: 1)
  - [ ] Set up YouTube Data API v3 client
  - [ ] Implement OAuth2 flow for YouTube access
  - [ ] Create endpoint to fetch user's subscribed channels
  - [ ] Handle API rate limiting and error cases

- [ ] Task 2: Create channel selection UI components (AC: 2, 3, 6)
  - [ ] Design channel list component with checkboxes
  - [ ] Implement channel selection state management
  - [ ] Add channel count validation (max 10)
  - [ ] Create channel display in dashboard sidebar
  - [ ] Add visual feedback for selected channels

- [ ] Task 3: Implement digest frequency preferences (AC: 4)
  - [ ] Create frequency selection component (daily/weekly/monthly)
  - [ ] Add frequency validation logic
  - [ ] Implement frequency state management
  - [ ] Add frequency display in UI

- [ ] Task 4: Create database schema and persistence layer (AC: 5, 7)
  - [ ] Design user preferences table schema
  - [ ] Create Prisma model for user preferences
  - [ ] Implement preferences CRUD operations
  - [ ] Add database migration scripts
  - [ ] Implement session persistence logic

- [ ] Task 5: Implement save and confirmation functionality (AC: 8)
  - [ ] Create save preferences endpoint
  - [ ] Add loading states during save
  - [ ] Implement success/error notifications
  - [ ] Add validation before saving
  - [ ] Test save functionality end-to-end

- [ ] Task 6: Add comprehensive testing (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Unit tests for channel selection logic
  - [ ] Integration tests for YouTube API calls
  - [ ] E2E tests for complete channel onboarding flow
  - [ ] Test persistence across browser sessions
  - [ ] Test error handling and edge cases

## Dev Notes

### Previous Story Insights
- Story 1.10 completed successfully with Railway deployment
- Authentication system is working with mock data
- Frontend-backend communication established
- OAuth flow needs to be extended for YouTube API access

### Data Models
- User Preferences: `{userId: string, selectedChannels: string[], digestFrequency: 'daily' | 'weekly' | 'monthly', updatedAt: Date}`
- YouTube Channel: `{id: string, title: string, description: string, thumbnailUrl: string, subscriberCount: number}`
- [Source: docs/architecture/data-models.md]

### API Specifications
- YouTube API endpoint: `GET /api/youtube/channels` - Fetch user's subscribed channels
- Preferences endpoint: `POST /api/preferences` - Save user preferences
- Preferences endpoint: `GET /api/preferences` - Get user preferences
- [Source: docs/architecture/rest-api-spec.md]

### Component Specifications
- ChannelList component: Displays checkboxes for channel selection
- FrequencySelector component: Radio buttons for digest frequency
- ChannelSidebar component: Shows selected channels in dashboard
- [Source: docs/architecture/components.md]

### File Locations
- YouTube API service: `src/modules/youtube/youtube.service.ts`
- Preferences controller: `src/modules/preferences/preferences.controller.ts`
- Channel components: `frontend/src/components/channels/`
- [Source: docs/source-tree.md]

### Testing Requirements
- Unit tests: Test YouTube API service and preferences logic
- Integration tests: Test API endpoints with supertest
- E2E tests: Test complete channel onboarding flow with Playwright
- Mock YouTube API responses for testing
- [Source: docs/architecture/testing-strategy.md]

### Technical Constraints
- YouTube API quota limits (10,000 units per day)
- Maximum 10 channels per user
- OAuth2 required for YouTube API access
- Must handle API rate limiting gracefully
- [Source: docs/architecture/external-apis.md]

### Security Considerations
- YouTube OAuth2 tokens must be securely stored
- User preferences must be user-scoped
- API keys must be environment variables
- [Source: docs/architecture/security.md]

## Testing
- **Test file location**: `src/modules/preferences/__tests__/preferences.service.spec.ts`
- **Test standards**: Use Jest and supertest for API testing
- **Testing frameworks**: Jest for unit tests, supertest for API tests, Playwright for E2E
- **Specific testing requirements**: 
  - Test YouTube API integration with mocked responses
  - Test channel selection validation (max 10)
  - Test preferences persistence
  - Test OAuth2 flow for YouTube access
  - Test error handling for API failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | @sm.mdc |

## Dev Agent Record

### Agent Model Used
[To be populated by dev agent]

### Debug Log References
[To be populated by dev agent]

### Completion Notes List
[To be populated by dev agent]

### File List
[To be populated by dev agent]

## QA Results
[To be populated by qa agent]
